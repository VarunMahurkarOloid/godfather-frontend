import { useState, useEffect } from 'react';
import { adminAPI, playerAPI } from '../services/api';

function Admin() {
  const [players, setPlayers] = useState([]);
  const [selectedPlayer, setSelectedPlayer] = useState('');
  const [amount, setAmount] = useState('');
  const [newsTitle, setNewsTitle] = useState('');
  const [newsMessage, setNewsMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState({ type: '', text: '' });
  const [activeTab, setActiveTab] = useState('players');

  // Role assignment states
  const [rolePlayer, setRolePlayer] = useState('');
  const [role, setRole] = useState('');
  const [family, setFamily] = useState('');

  useEffect(() => {
    fetchPlayers();
  }, []);

  const fetchPlayers = async () => {
    try {
      const response = await playerAPI.getAllPlayers();
      setPlayers(response.data);
    } catch (error) {
      console.error('Error fetching players:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleUpdateMoney = async (e) => {
    e.preventDefault();
    setMessage({ type: '', text: '' });

    try {
      await adminAPI.updateMoney(parseInt(selectedPlayer), parseFloat(amount));
      setMessage({ type: 'success', text: 'Money updated successfully!' });
      setSelectedPlayer('');
      setAmount('');
      fetchPlayers();
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to update money' });
    }
  };

  const handlePublishNews = async (e) => {
    e.preventDefault();
    setMessage({ type: '', text: '' });

    try {
      await adminAPI.publishNews(newsTitle, newsMessage);
      setMessage({ type: 'success', text: 'News published successfully!' });
      setNewsTitle('');
      setNewsMessage('');
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to publish news' });
    }
  };

  const handleEliminatePlayer = async (playerId) => {
    if (!confirm('Are you sure you want to eliminate this player?')) return;

    try {
      await adminAPI.eliminatePlayer(playerId);
      setMessage({ type: 'success', text: 'Player eliminated successfully!' });
      fetchPlayers();
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to eliminate player' });
    }
  };

  const handleRevivePlayer = async (playerId) => {
    try {
      await adminAPI.revivePlayer(playerId);
      setMessage({ type: 'success', text: 'Player revived successfully!' });
      fetchPlayers();
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to revive player' });
    }
  };

  const handleAssignRole = async (e) => {
    e.preventDefault();
    setMessage({ type: '', text: '' });

    try {
      await adminAPI.assignRole(rolePlayer, role, family);
      setMessage({ type: 'success', text: `Role assigned successfully!` });
      setRolePlayer('');
      setRole('');
      setFamily('');
      fetchPlayers();
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to assign role' });
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: 'var(--bg-primary)' }}>
        <div className="loading-spinner"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen py-8" style={{ backgroundColor: 'var(--bg-primary)' }}>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="mafia-title text-5xl font-bold mb-8" style={{ color: 'var(--text-primary)' }}>Godfather Dashboard</h1>

        {/* Tabs */}
        <div className="flex border-b-2 mb-8" style={{ borderColor: 'var(--border-color)' }}>
          <button
            onClick={() => setActiveTab('players')}
            className={`px-6 py-3 text-xl font-semibold transition-all ${
              activeTab === 'players'
                ? 'border-b-4'
                : 'opacity-60 hover:opacity-100'
            }`}
            style={{
              color: 'var(--text-primary)',
              borderColor: activeTab === 'players' ? 'var(--accent-primary)' : 'transparent'
            }}
          >
            Players
          </button>
          <button
            onClick={() => setActiveTab('tools')}
            className={`px-6 py-3 text-xl font-semibold transition-all ${
              activeTab === 'tools'
                ? 'border-b-4'
                : 'opacity-60 hover:opacity-100'
            }`}
            style={{
              color: 'var(--text-primary)',
              borderColor: activeTab === 'tools' ? 'var(--accent-primary)' : 'transparent'
            }}
          >
            Admin Tools
          </button>
        </div>

        {message.text && (
          <div className={`mb-8 p-6 rounded-lg ${
            message.type === 'success' ? 'bg-green-900 bg-opacity-50 text-green-200' : 'bg-red-900 bg-opacity-50 text-red-200'
          }`}>
            <p className="text-xl">{message.text}</p>
          </div>
        )}

        {/* Players Tab */}
        {activeTab === 'players' && (
          <div className="rounded-lg shadow-lg p-8 border-2" style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--accent-primary)' }}>
            <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>All Players</h2>

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b-2" style={{ borderColor: 'var(--border-color)' }}>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>ID</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Name</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Email</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Role</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Family</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Balance</th>
                    <th className="text-left py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {players.map((player, idx) => (
                    <PlayerRow
                      key={player.player_id || idx}
                      player={player}
                      onUpdate={fetchPlayers}
                      setMessage={setMessage}
                    />
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Admin Tools Tab */}
        {activeTab === 'tools' && (
          <div>
            {/* Assign Role Form - Full Width */}
            <div className="rounded-lg shadow-lg p-8 border-2 mb-8" style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)' }}>
              <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>Assign Role & Family to Player</h2>
              <form onSubmit={handleAssignRole} className="grid gap-5 md:grid-cols-3">
                <select
                  value={rolePlayer}
                  onChange={(e) => setRolePlayer(e.target.value)}
                  className="w-full px-4 py-4 text-lg rounded-lg"
                  style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                  required
                >
                  <option value="">Select player...</option>
                  {players.filter(p => (!p.assigned_role || p.assigned_role === '') && p.role !== 'Godfather').map((player) => (
                    <option key={player.player_id} value={player.player_id}>
                      {player.name} ({player.email})
                    </option>
                  ))}
                </select>

                <select
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="w-full px-4 py-4 text-lg rounded-lg"
                  style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                  required
                >
                  <option value="">Select role...</option>
                  <option value="Don">Don ($250,000)</option>
                  <option value="Caporegime">Caporegime ($100,000)</option>
                  <option value="Detective">Detective ($50,000)</option>
                  <option value="Merchant">Merchant ($75,000)</option>
                  <option value="Doctor">Doctor ($50,000)</option>
                  <option value="Citizen">Citizen ($25,000)</option>
                </select>

                <select
                  value={family}
                  onChange={(e) => setFamily(e.target.value)}
                  className="w-full px-4 py-4 text-lg rounded-lg"
                  style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                  required
                >
                  <option value="">Select family...</option>
                  <option value="Tattaglia">Tattaglia</option>
                  <option value="Barzini">Barzini</option>
                  <option value="Cuneo">Cuneo</option>
                  <option value="Stracci">Stracci</option>
                </select>

                <button
                  type="submit"
                  className="mafia-button md:col-span-3 py-4 px-4 text-xl rounded-lg font-bold"
                  style={{ backgroundColor: 'var(--accent-primary)', color: 'var(--text-primary)' }}
                >
                  Assign Role & Family
                </button>
              </form>
            </div>

            <div className="grid gap-8 lg:grid-cols-2 mb-8">
              {/* Update Money */}
              <div className="rounded-lg shadow-lg p-8 border-2" style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--accent-primary)' }}>
                <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>Update Player Money</h2>
                <form onSubmit={handleUpdateMoney} className="space-y-5">
                  <select
                    value={selectedPlayer}
                    onChange={(e) => setSelectedPlayer(e.target.value)}
                    className="w-full px-4 py-4 text-lg rounded-lg"
                    style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                    required
                  >
                    <option value="">Select player...</option>
                    {players.map((player) => (
                      <option key={player.player_id} value={player.player_id}>
                        {player.name} - ${player.balance || player.money || 0}
                      </option>
                    ))}
                  </select>

                  <input
                    type="number"
                    value={amount}
                    onChange={(e) => setAmount(e.target.value)}
                    placeholder="Amount (positive to add, negative to deduct)"
                    className="w-full px-4 py-4 text-lg rounded-lg"
                    style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                    required
                  />

                  <button
                    type="submit"
                    className="w-full py-4 px-4 text-xl rounded-lg font-bold"
                    style={{ backgroundColor: 'var(--accent-primary)', color: 'var(--text-primary)' }}
                  >
                    Update Money
                  </button>
                </form>
              </div>

              {/* Publish News */}
              <div className="rounded-lg shadow-lg p-8 border-2" style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)' }}>
                <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>Publish News</h2>
                <form onSubmit={handlePublishNews} className="space-y-5">
                  <input
                    type="text"
                    value={newsTitle}
                    onChange={(e) => setNewsTitle(e.target.value)}
                    placeholder="News title"
                    className="w-full px-4 py-4 text-lg rounded-lg"
                    style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                    required
                  />

                  <textarea
                    value={newsMessage}
                    onChange={(e) => setNewsMessage(e.target.value)}
                    placeholder="News message"
                    rows="5"
                    className="w-full px-4 py-4 text-lg rounded-lg"
                    style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
                    required
                  />

                  <button
                    type="submit"
                    className="w-full py-4 px-4 text-xl rounded-lg font-bold"
                    style={{ backgroundColor: 'var(--accent-primary)', color: 'var(--text-primary)' }}
                  >
                    Publish News
                  </button>
                </form>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="rounded-lg shadow-lg p-8 border-2" style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--accent-primary)' }}>
              <h2 className="text-3xl font-bold mb-6" style={{ color: 'var(--text-primary)' }}>Quick Actions</h2>
              <div className="grid gap-4">
                {players.map((player) => (
                  <div key={player.player_id} className="p-6 rounded-lg flex justify-between items-center" style={{ backgroundColor: 'var(--bg-tertiary)' }}>
                    <div>
                      <p className="font-semibold text-xl" style={{ color: 'var(--text-primary)' }}>{player.name}</p>
                      <p className="text-lg" style={{ color: 'var(--text-secondary)' }}>
                        {player.role || 'No Role'} | {player.family || 'No Family'} | ${player.balance || player.money || 0}
                      </p>
                    </div>
                    <div className="flex gap-3">
                      {player.role !== 'Godfather' && (
                        player.alive ? (
                          <button
                            onClick={() => handleEliminatePlayer(player.player_id)}
                            className="px-5 py-3 bg-red-600 hover:bg-red-700 text-white rounded text-lg font-medium"
                          >
                            Eliminate
                          </button>
                        ) : (
                          <button
                            onClick={() => handleRevivePlayer(player.player_id)}
                            className="px-5 py-3 bg-green-600 hover:bg-green-700 text-white rounded text-lg font-medium"
                          >
                            Revive
                          </button>
                        )
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// PlayerRow component for inline role assignment
function PlayerRow({ player, onUpdate, setMessage }) {
  const [isEditing, setIsEditing] = useState(false);
  const [editRole, setEditRole] = useState(player.assigned_role || player.role || '');
  const [editFamily, setEditFamily] = useState(player.family || '');

  const handleSaveRole = async () => {
    if (!editRole || !editFamily) {
      setMessage({ type: 'error', text: 'Please select both role and family' });
      return;
    }

    // Prevent assigning Godfather role
    if (editRole === 'Godfather' && player.role !== 'Godfather') {
      setMessage({ type: 'error', text: 'Cannot assign Godfather role to other players!' });
      return;
    }

    try {
      await adminAPI.assignRole(player.player_id, editRole, editFamily);
      setMessage({ type: 'success', text: `Role updated for ${player.name}` });
      setIsEditing(false);
      onUpdate();
    } catch (error) {
      setMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to update role' });
    }
  };

  const isGodfather = player.role === 'Godfather' || player.assigned_role === 'Godfather';

  return (
    <tr className="border-b" style={{ borderColor: 'var(--border-color)' }}>
      <td className="py-4 px-4 text-base" style={{ color: 'var(--text-secondary)' }}>
        {player.player_id?.substring(0, 8) || 'N/A'}
      </td>
      <td className="py-4 px-4 text-lg font-medium" style={{ color: 'var(--text-primary)' }}>
        {player.name}
      </td>
      <td className="py-4 px-4 text-base" style={{ color: 'var(--text-secondary)' }}>
        {player.email}
      </td>
      <td className="py-4 px-4">
        {isEditing && !isGodfather ? (
          <select
            value={editRole}
            onChange={(e) => setEditRole(e.target.value)}
            className="px-3 py-2 text-base rounded"
            style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
          >
            <option value="">Select role...</option>
            <option value="Don">Don</option>
            <option value="Caporegime">Caporegime</option>
            <option value="Detective">Detective</option>
            <option value="Merchant">Merchant</option>
            <option value="Doctor">Doctor</option>
            <option value="Citizen">Citizen</option>
          </select>
        ) : (
          <span className="text-lg" style={{ color: 'var(--text-primary)' }}>
            {player.assigned_role || player.role || 'Not Assigned'}
          </span>
        )}
      </td>
      <td className="py-4 px-4">
        {isEditing && !isGodfather ? (
          <select
            value={editFamily}
            onChange={(e) => setEditFamily(e.target.value)}
            className="px-3 py-2 text-base rounded"
            style={{ backgroundColor: 'var(--bg-tertiary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)', border: '1px solid' }}
          >
            <option value="">Select family...</option>
            <option value="Tattaglia">Tattaglia</option>
            <option value="Barzini">Barzini</option>
            <option value="Cuneo">Cuneo</option>
            <option value="Stracci">Stracci</option>
          </select>
        ) : (
          <span className="text-lg" style={{ color: 'var(--text-primary)' }}>
            {player.family || 'Not Assigned'}
          </span>
        )}
      </td>
      <td className="py-4 px-4 text-lg font-semibold" style={{ color: 'var(--text-primary)' }}>
        ${player.balance || player.money || 0}
      </td>
      <td className="py-4 px-4">
        {!isGodfather && (
          isEditing ? (
            <div className="flex gap-2">
              <button
                onClick={handleSaveRole}
                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-base font-medium"
              >
                Save
              </button>
              <button
                onClick={() => {
                  setIsEditing(false);
                  setEditRole(player.assigned_role || player.role || '');
                  setEditFamily(player.family || '');
                }}
                className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded text-base font-medium"
              >
                Cancel
              </button>
            </div>
          ) : (
            <button
              onClick={() => setIsEditing(true)}
              className="px-4 py-2 rounded text-base font-medium"
              style={{ backgroundColor: 'var(--accent-primary)', color: 'var(--text-primary)' }}
            >
              Assign Role
            </button>
          )
        )}
        {isGodfather && (
          <span className="px-4 py-2 text-base font-medium" style={{ color: 'var(--text-secondary)' }}>
            Protected
          </span>
        )}
      </td>
    </tr>
  );
}

export default Admin;
